indataBody = """Mouth_open,0.8,0.1,0,0.1,0.8,0.6,0.5,0.8,0.1,0.6,1,1,0.8,0.6,1,1,0.3,0.5,0,0.7
Eyes_left,0,0.1,0.5,0,0,0.9,0.3,0,0.8,0.1,0.5,0.5,0,0.9,0.4,0.4,0.7,0.3,0.5,1
Eyes_right,0.5,0.8,0.6,0.5,0.5,0.1,0.7,0.5,0,0.8,0.3,0.3,0.5,0.1,0.6,0.6,1,0.7,0.3,0.4
Eyes_up,0.3,0,-0.9,-0.3,-0.3,-0.2,-1,0.3,0.5,0,0.7,0.7,0.4,0.8,0.1,0.1,0.5,1,0.7,0.6
Eyes_down,0.7,-0.5,-0.1,-0.7,-0.7,-0.1,-0.4,0.7,0.3,0.5,1,1,0.6,0,0.8,0.8,0.3,0.4,1,0.1
Phoneme_mbp,1,-0.3,-0.2,-1,-1,-0.1,-0.6,1,0.7,0.3,0.4,0.4,0.9,0.5,0,0,0.7,0.5,0.1,1
Phoneme_OO,0.4,-0.7,-0.1,-0.4,-0.4,-0.8,-0.1,0.5,1,0.7,0.6,0.6,0.1,0.3,0.5,0.5,1,0.3,0.1,0.4
Phoneme_FV,0.6,-1,-0.1,-0.6,-0.6,0,-0.8,0.3,0.4,1,0.1,0.1,0.2,0.7,0.3,0.3,0.4,0.7,0.8,0.8
Phoneme_CH,0.9,-0.4,-0.8,-0.1,-0.9,-0.5,0,0.7,0.5,0.1,1,0.7,0.1,-1,-0.7,-0.7,-0.6,1,0,0
Left_eye_blink,0.1,-0.6,0,-0.8,-0.1,-0.3,-0.5,1,0.3,0.1,0.4,1,0.2,-0.4,-1,-1,-0.1,0.4,0.5,0.5
Right_eye_blink,0.2,-0.9,-0.5,0,-0.2,-0.7,-0.3,0.4,0.7,0.8,0.8,0.5,0.7,-0.8,-0.8,-0.5,-0.7,0.4,0.5,0.5
Left_eye_wide_open,0.8,-0.1,-0.3,-0.5,-0.1,-1,-0.7,0.6,1,0,0,0.3,1,0,0,-0.3,-1,0.6,0.3,0.3
Right_eye_wide_open,0,0.2,0.7,0.7,0.1,1,0.7,0.7,0.4,0.5,0.5,0.7,0.4,-0.5,-0.5,-0.1,-0.4,0.9,0.7,0.1
Left_brow_up,0.5,0.1,1,1,0.2,0.4,1,1,0.6,0.3,0.3,1,0.6,-0.3,-0.3,-0.8,-0.6,0.1,1,0.8
Right_brow_up,0.3,0.1,0.4,0.5,0.7,0.8,0.8,0.5,0.9,0.7,0.1,0.4,0.9,-0.7,-0.1,0,-0.1,0.2,0.4,0
Left_brow_down,0.7,0.8,0.8,0.3,1,0,0,-0.3,-0.1,-1,-0.8,0.6,0.1,-1,-0.8,-0.9,-0.3,0,0,0.8
Right_brow_down,1,0,0,0.7,0.4,0.5,0.5,-0.1,-0.2,-0.4,0,0.1,0.2,-0.4,0,-0.1,-0.7,0.5,0.5,0
Mid_brows_up,0.4,0.5,0.5,1,0.6,0.3,0.3,-0.8,-0.5,0,-0.9,0.3,0,0,0.8,0.8,0.1,0.5,0.3,0.5
Mid_brows_down,0.6,0.3,0.3,0.4,0.9,0.7,0.1,0,-0.3,-0.5,-0.1,0.7,0.5,0.5,0,0,0.8,0.3,0.7,0.3
Upper_Lip_Up_left,0.9,0.7,0.1,0.6,0.1,1,0.8,-0.9,-0.7,-0.4,-0.8,0.1,0.5,0.3,0.5,1,0.6,0,0.8,0.3
Upper_Lip_Up_right,0.1,1,0.8,0.1,0.2,0.4,0,-0.1,-1,-0.6,0,0.8,0.3,0.7,0.3,0.4,0.9,0.5,0,0.7
Lower_Lip_Down_left,0.2,0.4,0,0.3,0,0,0.8,-0.8,-0.4,-0.9,-0.5,0,0.7,1,0.7,0.6,0.1,0.3,0.5,1
Lower_Lip_Down_right,0.8,0.6,0.5,0.7,0.5,0.5,0,0,-0.6,-0.1,-0.3,0.5,1,0.4,1,0.1,0.2,0.7,0.3,0.4
Mouth_Stretch_left,0,0.9,0.3,0.1,0.5,0.3,0.5,-1,-0.1,-0.2,-0.7,0.3,0.4,0.8,0.8,0.5,0.1,1,0.7,0.6
Mouth_Stretch_right,0.5,0.1,0.7,0.5,0.8,0.5,0.1,-1,-0.7,-0.1,-1,0.7,0.6,0,0,0.3,0.2,0.4,1,0.1
Mouth_Right,0.3,0.2,1,0.3,0,0.3,0.1,-0.4,-1,-0.2,-0.4,1,0.1,0.5,0.5,0.7,0.7,0.8,0.8,0.5
Mouth_Left,0.7,0.1,0.4,0.7,0.5,0.7,0.8,0.8,0.5,0.7,0.8,0.8,0.5,0.3,0.3,0.5,0,0.7,1,0.7
Jaw_left,1,0.1,0.6,1,0.3,1,0,0,0.3,1,0,0,0.3,0.7,0.1,0.3,0.5,1,0.4,1
Jaw_right,0.4,0.8,0.1,0.5,0.7,0.4,0.5,0.5,0.7,0.4,0.5,0.5,0.7,1,0.8,0.7,0.3,0.4,0.8,0.8
Mouth_up,0.6,0,0.8,0.3,1,0.6,0.3,0.3,1,0.6,0.3,0.3,1,0.4,0,1,0.7,0.6,0,0
Mouth_down,0.9,0.5,0,0.7,0.4,0.9,0.7,0.1,0.4,0.9,0.7,0.1,0.4,1,0.8,0.4,1,0.1,0.5,0.5
Smile_left,0.1,0.3,0.5,1,0.6,0.1,1,0.8,0.6,0.1,1,0.8,0.6,0.6,0.3,0.8,0.8,0.5,0.3,0.3
Smile_right,0.2,0.7,0.3,0.4,0.9,0.2,0.4,0,0.1,0.2,0.4,0,0.1,0.9,0.7,0,0,0.3,0.7,0.1
Mouth_Narrow_left,0.1,1,0.7,0.6,0.6,1,0.1,0.6,0.6,0.1,1,0.8,0.6,0.1,1,0.5,0.5,0.7,1,0.8
Mouth_Narrow_right,0.2,0.4,1,0.1,0.9,0.4,0.8,0.1,0.9,0.2,0.4,0,0.1,0.2,0.4,0.3,0.3,1,0.4,0"""

indataHead= """Mouth_open,
Eyes_left,
Eyes_right,
Eyes_up,
Eyes_down,
Phoneme_mbp,
Phoneme_OO,
Phoneme_FV,
Phoneme_CH,
Left_eye_blink,
Right_eye_blink,
Left_eye_wide_open,
Right_eye_wide_open,
Left_brow_up,
Right_brow_up,
Left_brow_down,
Right_brow_down,
Mid_brows_up,
Mid_brows_down,
Upper_Lip_Up_left,
Upper_Lip_Up_right,
Lower_Lip_Down_left,
Lower_Lip_Down_right,
Mouth_Stretch_left,
Mouth_Stretch_right,
Mouth_Right,
Mouth_Left,
Jaw_left,
Jaw_right,
Mouth_up,
Mouth_down,
Smile_left,
Smile_right,
Mouth_Narrow_left,
Mouth_Narrow_right,"""

import collections
import sys
import socket
import time


def getJsonShapes(map):
    jsonstr = ''
    jsonSubject = """\
                {{
                  "shape": "{0}",
                  "channelId": {1}
                }}{2}
"""
    pos = 0
    lastpos = len(map.keys())-1
    sep = ','
    for shape in map.keys():
        if pos == lastpos: sep = ''
        jsonstr = jsonstr + jsonSubject.format(shape,pos,sep)
        pos += 1
    return jsonstr

def getJsonSubjects(map):
    jsonSubjects = """\
    {{
            "name": "{0}",
            "targets": [
{1}
            ]
    }}
"""
    jsonShapes = getJsonShapes(map)
    name = 'facebody1'
    jsonstr = jsonSubjects.format(name, jsonShapes)
    return jsonstr

def getJsonHeader(map):
    """
    create json string of header
    :param map: map of shapes
    :return: string
    """
    jsonstr = ''

    jsonTop = """\
{{
    "subjects": [
        {0}
    ]
}}"""
    jsonSubject = getJsonSubjects(map)
    jsonstr = jsonTop.format(jsonSubject)
    jsize = len(jsonstr)
    jsonstr = '%07d'%jsize + jsonstr
    return jsonstr

def getJsonChannel(map,pos):
    jsonstr = ''
    frame = []
    for data in map.items():
        vlist = data[1]
        frame.append('           '+str(float(vlist[pos])))

    jsonstr =  ',\n'.join(frame)
    return jsonstr

def getJsonFrame(map,pos,timecode):
    jsonstr = ''

    jsonFrame = """\
{{
    "frameno": {0},
    "timecode": [{1}],
    "channels": [
{2}
      ]
}}
    """
    frames = getJsonChannel(map,pos)
    jsonstr = jsonFrame.format(pos,timecode,frames)
    jsize = len(jsonstr)
    jsonstr = '%07d'%jsize + jsonstr
    return jsonstr

def FacialStream(indata):
    inlines = indata.split('\n')
    headMap = collections.OrderedDict()
    for line in inlines:
        data = line.split(',')
        #print data[0]
        #print data[1:]
        shape = data[0].strip()
        vlist = data[1:]
        headMap[shape] = vlist
    jsonHeader = getJsonHeader(headMap)
    # print jsonHeader

    # get frames
    for pos in range(len(headMap.items()[0][1])):
        jsonFrame = getJsonFrame(headMap,pos,'0,0,0,0')
        # print jsonFrame

    ## socket code
    sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    #server_address = ('114.212.123.239',8080)      #host ip
    server_address = ('192.168.20.2', 20000)
    print >> sys.stderr, 'starting up on %s port %s' % server_address
    sock.bind(server_address)

    sock.listen(1)

    while True:
        #Waiting for connection
        print >> sys.stderr, 'waiting for a connection'
        connection, client_address = sock.accept()
        try:
            print >>sys.stderr, 'connection from', client_address

            # Receive the data in small chunks and retransmit it
            print >>sys.stderr, 'sending data back to the client'
            connection.sendall(jsonHeader)
            while True:
                #data = connection.recv(16)
                #print >>sys.stderr, 'received "%s"' % data
                for pos in range(len(headMap.items()[0][1])):
                    time.sleep(0.066)
                    jsonFrame = getJsonFrame(headMap,pos,'0,0,0,0')
                    print jsonFrame
                    connection.sendall(jsonFrame)
        finally:
            # Clean up the connection
            connection.close()
            
####################################################################################################
global connection
global client_address
		
def FacialStreamConnect():
    global connection
    global client_address
    ## socket code
    sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    server_address = ('114.212.123.239',8080)      #host ip
    #server_address = ('10.188.184.63', 20000)
    print >> sys.stderr, 'starting up on %s port %s' % server_address
    sock.bind(server_address)
    sock.listen(1)
    print >> sys.stderr, 'waiting for a connection'
    connection, client_address = sock.accept()
    print >>sys.stderr, 'connection from', client_address
        
def FacialStreamClose():
    global connection
    global client_address
    connection.close()

def FacialStreamHead(indata):
    global connection
    global client_address
    inlines = indata.split('\n')
    headMap = collections.OrderedDict()
    for line in inlines:
        data = line.split(',')
        #print data[0]
        #print data[1:]
        shape = data[0].strip()
        vlist = data[1:]
        headMap[shape] = vlist
    jsonHeader = getJsonHeader(headMap)
    print jsonHeader
    print >>sys.stderr, 'sending data back to the client'
    connection.sendall(jsonHeader)

			
def FacialStreamValue(indata):
    global connection
    global client_address
    inlines = indata.split('\n')
    headMap = collections.OrderedDict()
    for line in inlines:
        data = line.split(',')
        #print data[0]
        #print data[1:]
        shape = data[0].strip()
        vlist = data[1:]
        headMap[shape] = vlist
    jsonHeader = getJsonHeader(headMap)
    #print jsonHeader

    # get frames
    for pos in range(len(headMap.items()[0][1])):
        jsonFrame = getJsonFrame(headMap,pos,'0,0,0,0')
        #print jsonFrame
        connection.sendall(jsonFrame)


'''
if __name__ == '__main__':
    #main()
    FacialStreamConnect()
    FacialStreamHead(indataHead)
    FacialStreamValue(indataBody)
    FacialStreamClose()
'''
